<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hero Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #00d4ff; margin-bottom: 20px; }
        
        /* Login Section */
        .login-section { background: #16213e; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .login-section input { padding: 10px; margin-right: 10px; border: none; border-radius: 5px; width: 300px; }
        .login-section button { padding: 10px 20px; background: #00d4ff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .login-section button:hover { background: #00a8cc; }
        
        /* Status */
        .status { padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center; }
        .status.connected { background: #0f5132; color: #75b798; }
        .status.disconnected { background: #842029; color: #ea868f; }
        
        /* Chat Layout */
        .chat-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* Chat Box */
        .chat-box { background: #16213e; border-radius: 10px; overflow: hidden; }
        .chat-header { background: #0f3460; padding: 15px; font-weight: bold; }
        .chat-header.feed { border-left: 4px solid #00d4ff; }
        .chat-header.private { border-left: 4px solid #e94560; }
        .chat-header.notification { border-left: 4px solid #ffc107; }
        
        .messages { height: 300px; overflow-y: auto; padding: 15px; }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 8px; background: #1a1a2e; }
        .message .sender { font-weight: bold; color: #00d4ff; }
        .message .time { font-size: 0.8em; color: #888; margin-left: 10px; }
        .message .content { margin-top: 5px; }
        .message.system { background: #2d2d44; border-left: 3px solid #ffc107; }
        .message.private { border-left: 3px solid #e94560; }
        
        /* Input Area */
        .input-area { padding: 15px; background: #0f3460; display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 10px; border: none; border-radius: 5px; }
        .input-area button { padding: 10px 20px; background: #00d4ff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .input-area button:hover { background: #00a8cc; }
        
        /* Notification Box */
        .notification-box { grid-column: 1 / -1; }
        .notification-box .messages { height: 150px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü¶∏ Hero Chat System</h1>
        
        <!-- Login -->
        <div class="login-section">
            <input type="text" id="tokenInput" placeholder="Nh·∫≠p JWT Token...">
            <button onclick="connect()">K·∫øt n·ªëi</button>
            <button onclick="disconnect()">Ng·∫Øt k·∫øt n·ªëi</button>
        </div>
        
        <!-- Status -->
        <div id="status" class="status disconnected">Ch∆∞a k·∫øt n·ªëi</div>
        
        <!-- Chat Layout -->
        <div class="chat-layout">
            <!-- Feed Chat -->
            <div class="chat-box">
                <div class="chat-header feed">üì¢ Feed Chat (C√¥ng khai)</div>
                <div class="messages" id="feedMessages"></div>
                <div class="input-area">
                    <input type="text" id="feedInput" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendFeedMessage()">
                    <button onclick="sendFeedMessage()">G·ª≠i</button>
                </div>
            </div>
            
            <!-- Private Chat -->
            <div class="chat-box">
                <div class="chat-header private">üîí Private Chat (Ri√™ng t∆∞)</div>
                <div class="messages" id="privateMessages"></div>
                <div class="input-area">
                    <input type="text" id="targetHeroId" placeholder="Hero ID..." style="width: 100px; flex: none;">
                    <input type="text" id="privateInput" placeholder="Tin nh·∫Øn ri√™ng..." onkeypress="if(event.key==='Enter') sendPrivateMessage()">
                    <button onclick="sendPrivateMessage()">G·ª≠i</button>
                </div>
            </div>
            
            <!-- Notifications -->
            <div class="chat-box notification-box">
                <div class="chat-header notification">üîî Th√¥ng b√°o h·ªá th·ªëng</div>
                <div class="messages" id="notifications"></div>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let currentUserId = null;

        // Decode JWT ƒë·ªÉ l·∫•y userId
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        // Load token t·ª´ localStorage khi trang load v√† t·ª± ƒë·ªông k·∫øt n·ªëi
        window.onload = async function() {
            const savedToken = localStorage.getItem('heroToken');
            if (savedToken) {
                document.getElementById('tokenInput').value = savedToken;
                await connect(); // T·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i
            }
        };

        async function connect() {
            const token = document.getElementById('tokenInput').value;
            if (!token) {
                alert('Vui l√≤ng nh·∫≠p token!');
                return;
            }

            // L·∫•y userId t·ª´ token
            const payload = parseJwt(token);
            currentUserId = payload?.nameid || payload?.sub || null;

            // L∆∞u token v√†o localStorage
            localStorage.setItem('heroToken', token);

            // Load l·ªãch s·ª≠ chat t·ª´ API
            await loadChatHistory();

            connection = new signalR.HubConnectionBuilder()
                .withUrl(`/hubs/hero?access_token=${encodeURIComponent(token)}`)
                .withAutomaticReconnect()
                .build();

            // Nh·∫≠n tin nh·∫Øn Feed
            connection.on("ReceiveFeedMessage", (user, message, time) => {
                addMessage('feedMessages', user, message, time);
            });

            // Nh·∫≠n tin nh·∫Øn ri√™ng
            connection.on("ReceivePrivateMessage", (senderName, message, time) => {
                addMessage('privateMessages', senderName, message, time, 'private');
            });

            // Nh·∫≠n th√¥ng b√°o h·ªá th·ªëng
            connection.on("ReceiveSystemNotification", (message) => {
                addNotification(message);
            });

            connection.onclose(() => updateStatus(false));
            connection.onreconnecting(() => updateStatus(false, 'ƒêang k·∫øt n·ªëi l·∫°i...'));
            connection.onreconnected(() => updateStatus(true));

            connection.start()
                .then(() => updateStatus(true))
                .catch(err => {
                    console.error(err);
                    updateStatus(false, 'L·ªói: ' + err.message);
                });
        }

        async function loadChatHistory() {
            try {
                // Load feed messages t·ª´ API
                const feedRes = await fetch('/api/feed-messages?limit=50');
                if (feedRes.ok) {
                    const feedData = await feedRes.json();
                    document.getElementById('feedMessages').innerHTML = '';
                    feedData.forEach(msg => {
                        if (msg && msg.senderName && msg.message) {
                            addMessage('feedMessages', msg.senderName, msg.message, msg.timestamp);
                        }
                    });
                }

                // Load notifications t·ª´ API (theo userId)
                if (currentUserId) {
                    const notifRes = await fetch(`/api/notifications?userId=${currentUserId}&limit=20`);
                    if (notifRes.ok) {
                        const notifData = await notifRes.json();
                        document.getElementById('notifications').innerHTML = '';
                        notifData.forEach(n => {
                            if (n && n.message) {
                                addNotification(n.message, n.timestamp);
                            }
                        });
                    }
                }
            } catch (err) {
                console.error('Load history error:', err);
            }
        }

        function disconnect() {
            if (connection) {
                connection.stop();
                connection = null;
            }
            // X√≥a token khi ng·∫Øt k·∫øt n·ªëi
            localStorage.removeItem('heroToken');
            document.getElementById('tokenInput').value = '';
        }

        function sendFeedMessage() {
            const message = document.getElementById('feedInput').value;
            if (message && connection) {
                connection.invoke("SendMessageToFeed", message)
                    .catch(err => console.error(err));
                document.getElementById('feedInput').value = '';
            }
        }

        function sendPrivateMessage() {
            const targetId = document.getElementById('targetHeroId').value;
            const message = document.getElementById('privateInput').value;
            if (targetId && message && connection) {
                connection.invoke("SendPrivateMessage", targetId, message)
                    .catch(err => console.error(err));
                document.getElementById('privateInput').value = '';
            }
        }

        function addMessage(containerId, sender, content, time, type = '') {
            const container = document.getElementById(containerId);
            const timeStr = new Date(time).toLocaleTimeString('vi-VN');
            container.innerHTML += `
                <div class="message ${type}">
                    <span class="sender">${sender}</span>
                    <span class="time">${timeStr}</span>
                    <div class="content">${content}</div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        function addNotification(message, time = null) {
            const container = document.getElementById('notifications');
            const timeStr = time ? new Date(time).toLocaleTimeString('vi-VN') : new Date().toLocaleTimeString('vi-VN');
            container.innerHTML += `
                <div class="message system">
                    <span class="time">${timeStr}</span>
                    <div class="content">${message}</div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        function updateStatus(connected, message = null) {
            const status = document.getElementById('status');
            if (connected) {
                status.className = 'status connected';
                status.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi';
            } else {
                status.className = 'status disconnected';
                status.textContent = message || '‚ùå Ch∆∞a k·∫øt n·ªëi';
            }
        }
    </script>
</body>
</html>
